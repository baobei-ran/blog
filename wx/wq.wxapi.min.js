
// 自己打算实现京东的 左上角关闭按钮事件（失败了。。。）

let arr = ["checkJsApi", "getNetworkType", "onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareWeibo", "hideMenuItems", "showMenuItems", "editAddress", "previewImage", "uploadImage", "downloadImage", "chooseImage", "setCloseWindowConfirmDialogInfo", "setPageTitle", "startRecord", "stopRecord", "onVoiceRecordEnd", "playVoice", "pauseVoice", "stopVoice", "onVoicePlayEnd", "uploadVoice", "getLocation", "openLocation", "scanQRCode", "launchMiniProgram", "openWXSearchPage", "launchApplication", "getInstallState", "openBusinessView", "chooseInvoiceTitle", "openCard", "hideAllNonBaseMenuItem"];

wx.config({
  debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
  appId: '', // 必填，公众号的唯一标识
  timestamp: '', // 必填，生成签名的时间戳
  nonceStr: '', // 必填，生成签名的随机串
  signature: '',// 必填，签名
  jsApiList: arr // 必填，需要使用的JS接口列表
});


wx.ready(function () {
  wx.checkJsApi({
    jsApiList: arr,
    success: function() {
      console.log("WXAPI全部OK")
    },
    fail: function(e ) {
      console.log("checkJsApi fail", e)
    }
  })
});
             

(function () {
  console.log("wxapijs loaded...", "20201201");
  try {
    function e() {
      window.WeixinJSBridge && window.WeixinJSBridge.invoke("setCloseWindowConfirmDialogInfo", {
        switch: "true",
        title_cn: "你要关闭购物页面?",
        title_eng: "Do not save the order info? ",
        ok_cn: "关闭",
        ok_eng: "OK",
        cancel_cn: "再逛逛",
        cancel_eng: "Cancel"
      }, function (e) {
        alert(JSON.stringify(e))  // system: access_denied （系统拒绝访问）
      })
    }
    window.WeixinJSBridge ? e() : document.addEventListener("WeixinJSBridgeReady", function () {
      e()
    })
  } catch (e) { }
})();


// 以下是 京东 调用微信的 api 

(function () {
  console.log("wxapijs loaded...", "20201201");
  try {
      function e() {
          window.WeixinJSBridge && window.WeixinJSBridge.invoke("setCloseWindowConfirmDialogInfo", {
              switch: "true",
              title_cn: "你要关闭购物页面?",
              title_eng: "Do not save the order info? ",
              ok_cn: "关闭",
              ok_eng: "OK",
              cancel_cn: "再逛逛",
              cancel_eng: "Cancel"
          }, function(e) {})
      }
      window.WeixinJSBridge ? e() : document.addEventListener("WeixinJSBridgeReady", function() {
          e()
      })
  } catch (e) {}
}
)(),
function() {
  try {
      var e = 0
        , n = 0
        , i = 0
        , o = "_wx_signature" + encodeURIComponent(location.href.split("#")[0])
        , t = "wx_api_ready"
        , r = "wx_sign_get"
        , a = "wx_js_get"
        , s = "wx_api_error"
        , c = "//wq.jd.com/bases/jssdk/GetWxJsApiSign"
        , l = "//res.wx.qq.com/open/js/jweixin-1.6.0.js"
        , d = "?t=1520942422518"
        , u = "_wx_api_store";
      function g(e, n) {
          try {
              var i = JSON.parse(sessionStorage.getItem(u)) || {};
              i[e] = n,
              sessionStorage.setItem(u, JSON.stringify(i))
          } catch (e) {}
      }
      function w(e) {
          var n;
          try {
              return window.JSON ? (n = JSON.parse(sessionStorage.getItem(u)) || {},
              n ? n[e] : null) : null
          } catch (e) {
              return null
          }
      }
      function p() {
          var e;
          try {
              window.JSON && (e = JSON.parse(sessionStorage.getItem(u)),
              e[o] && delete e[o])
          } catch (e) {
              return null
          }
      }
      function m(e) {
          var n = (new Date).getTime()
            , i = null;
          e ? (sessionStorage && p(),
          window.wx || JD.events.trigger(a)) : i = w(o),
          i && n - 1e3 * i.timestamp < 66e5 ? JD.wxapi.signatureReady(i) : h()
      }
      function f(e) {
          JD.events.trigger(s, e),
          JD.events.remove(s),
          JD.events.remove(t),
          console.log(e);
          try {
              JD.report.umpBiz({
                  bizid: "55",
                  operation: "20",
                  result: e.errorCode,
                  source: "0",
                  message: JSON.stringify(e)
              })
          } catch (e) {}
      }
      function h() {
          JD.sendJs(c + "?url=" + encodeURIComponent(location.href.split("#")[0]) + "&callback=getwxjssign2&t=" + Math.random(), {
              defer: !0,
              async: !0
          }),
          window.getwxjssign2 = function(n) {
              console.log("iSignErrCount..." + e),
              0 == n.errCode && (JD.wxapi.signatureReady(n),
              g(o, n),
              console.log("签名OK"))
          }
      }
      function _() {
          function e() {
              console.log("wxjsapi load success!"),
              JD.wxapi.jsReady(function(e) {
                  var n = !1
                    , o = ["checkJsApi", "getNetworkType", "onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareWeibo", "hideMenuItems", "showMenuItems", "editAddress", "previewImage", "uploadImage", "downloadImage", "chooseImage", "setCloseWindowConfirmDialogInfo", "setPageTitle", "startRecord", "stopRecord", "onVoiceRecordEnd", "playVoice", "pauseVoice", "stopVoice", "onVoicePlayEnd", "uploadVoice", "getLocation", "openLocation", "scanQRCode", "launchMiniProgram", "openWXSearchPage", "launchApplication", "getInstallState", "openBusinessView", "chooseInvoiceTitle", "openCard", "hideAllNonBaseMenuItem"];
                  console.log("begin config wx"),
                  wx.error(function(e) {
                      console.log("config error"),
                      -1 !== e.errMsg.indexOf("invalid signature") && 0 === i ? (i++,
                      n = !0,
                      JD.events.trigger(r, !0)) : f({
                          errorCode: 3,
                          errMsg: "JS其他错误"
                      })
                  }),
                  wx.ready(function() {
                      n || (console.log("config ready"),
                      wx.checkJsApi({
                          jsApiList: o,
                          success: function(e) {
                              console.log("WXAPI全部OK"),
                              wx.apiCheckResult = e.checkResult,
                              JD.wxapi.wxReady(),
                              JD.events.trigger(t, JD.wxapi.getSignature()),
                              JD.events.remove(t)
                          },
                          fail: function(e) {
                              console.log("checkJsApi fail", e)
                          }
                      }))
                  }),
                  wx.config({
                      beta: !0,
                      debug: !1,
                      appId: e.appId,
                      timestamp: e.timestamp,
                      nonceStr: e.nonceStr,
                      signature: e.signature,
                      jsApiList: o,
                      openTagList: ["wx-open-launch-weapp", "wx-open-launch-app"]
                  })
              })
          }
          var o = window.require && window.requirejs;
          o ? require([l + d], function(n) {
              window.wx = n,
              e()
          }) : JD.sendJs(l + d, {
              onLoad: function() {
                  e()
              },
              onError: function() {
                  console.log("iJsSdkErrCount..." + n),
                  n > 2 ? f({
                      errorCode: 2,
                      errMsg: "js加载错误"
                  }) : (n++,
                  d = "?" + Date.now(),
                  JD.events.trigger(a))
              },
              defer: !0,
              async: !0
          })
      }
      JD.events.listen(r, m, !1),
      JD.events.listen(a, _),
      console.log("begin load js");
      var R = 0;
      function J() {
          if (window.WeixinJSBridge)
              JD.events.trigger(a);
          else {
              if (R > 10)
                  return void f({
                      errorCode: 3,
                      errMsg: "loadJSAPI加载错误"
                  });
              setTimeout(function() {
                  console.log("loadJSAPI延时调用:" + 300 * (R + 1) + "ms"),
                  R++,
                  J()
              }, 300)
          }
      }
      window.WeixinJSBridge ? J() : document.addEventListener("WeixinJSBridgeReady", function() {
          console.log(WeixinJSBridge ? "bridge init OK" : "bridge init error"),
          J()
      }),
      window.GLOBAL_FORBIT_WXAPI || (JD.events.trigger(r),
      JD.report.umpBiz({
          bizid: "55",
          operation: "20",
          result: "0",
          source: "0",
          message: ""
      }))
  } catch (e) {}
}(),
function() {
  function e() {
      var e = function() {
          document.title && WeixinJSBridge && WeixinJSBridge.invoke("setPageTitle", {
              title: document.title
          }, function(e) {})
      };
      e(),
      window.addEventListener("pageshow", e, !1)
  }
  function n(e) {
      function n() {}
      function t() {
          function e(e, n, i) {
              "favorite" !== e.scene && !e.shareCallback && !window.JXJMARKETID && showTips(n),
              e.shareCallback && e.shareCallback(e.scene, n, i.errMsg)
          }
          function n(e) {
              function n() {}
              n.prototype = e;
              var i = new n;
              return i
          }
          function i() {
              if (window.JXJMARKETID)
                  return "17053.1.3";
              var e = JD.url.getUrlParam("ptag")
                , n = ""
                , i = JD.cookie.get("PPRD_P");
              if (i) {
                  var o = i.match(/EA\.([\d.]+)/);
                  o && o.length >= 2 && (n = o[1])
              }
              return e && /^(17067|17068)/.test(e) ? e.replace(/^(17067|17068)/, "17068") : n && /^(17067|17068)/.test(n) ? n.replace(/^(17067|17068)/, "17068") : "17053.1.1"
          }
          function t(e) {
              var n = JD.url.getUrlParam("pass_utm")
                , i = JD.url.getUrlParam("ptag", e);
              if (/utm_campaign/i.test(e) || "1" != n)
                  "17053.1.1" == i && (e = JD.url.addUrlParam(e, {
                      utm_source: "weixin",
                      utm_medium: "weixin",
                      utm_campaign: "t_1000072672_17053_001"
                  }));
              else {
                  var o = location.search.replace("?", "").replace("pass_utm=1", "").replace(/(^&|&$|&(?=&))/, "");
                  e = e + (e.indexOf("?") > -1 ? "&" : "?") + o
              }
              return e
          }
          function r() {
              var e, n = window.shareConfig || c;
              n.link = n.link || location.href.replace(/#.*$/, ""),
              n.link = JD.url.addRd(n.link, i()),
              n.link = t(n.link),
              -1 == n.link.indexOf("_share=") && (n.url = n.link + (-1 === n.link.indexOf("?") ? "?" : "&") + "_share=wx");
              var r = JD.url.getUrlParam("jxsid", n.link);
              return r && (JD.url.removeUrlParam ? n.link = JD.url.removeUrlParam("jxsid", n.link) : n.link = JD.url.addUrlParam(n.link, {
                  jxsid: ""
              })),
              o && (n.shareCallback = function(e, n, i) {
                  console.log(e + "-" + n + "-" + i)
              }
              ),
              e = {
                  shareCallback: n.shareCallback,
                  title: n.title,
                  timelineDesc: n.timelineDesc,
                  desc: n.desc,
                  link: n.link ? n.link.replace(/^((https||http):?)\/\//, location.protocol + "//") : n.link,
                  imgUrl: n.img_url ? n.img_url.replace(/^((https||http):?)\/\//, "http://") : n.img_url
              },
              window.GLOBAL_TRANSFER_BACKUPURL && window.GLOBAL_GET_BACKSHAREURL && (e.link = window.GLOBAL_GET_BACKSHAREURL(e.link)),
              e
          }
          function a() {
              var n = {
                  success: function(n) {
                      e(this, "ok", n)
                  },
                  cancel: function(n) {
                      e(this, "cancel", n)
                  },
                  fail: function(n) {
                      e(this, "fail", n)
                  }
              };
              return n
          }
          function s(e) {
              var i = n(a());
              return i.trigger = function(e) {
                  var n = r();
                  this.shareCallback = n.shareCallback,
                  this.title = n.title,
                  this.desc = n.desc,
                  this.timelineDesc = n.timelineDesc,
                  this.link = n.link,
                  this.imgUrl = n.imgUrl,
                  e && e.scene && (this.scene = e.scene),
                  "shareTimeline" === this.scene && (this.title = n.timelineDesc || n.desc,
                  this.desc = n.timelineDesc || n.desc),
                  console.log("拦截菜单事件 OK")
              }
              ,
              i.scene = e,
              i
          }
          wx.onMenuShareAppMessage(s("sendAppMessage")),
          wx.onMenuShareTimeline(s("shareTimeline")),
          wx.onMenuShareWeibo(s("shareWeibo")),
          wx.onMenuShareQQ(s("shareQQ"));
          var c = {
              img_url: "//img11.360buyimg.com/jdphoto/s100x100_jfs/t1/68505/3/10045/22997/5d79fa1dE7d41f091/1a4b8a12e59fc79d.png",
              link: "//wq.jd.com/mcoss/wxmall/home?ptype=1",
              title: "京喜",
              desc: "微信购物上京喜，省钱省心，超多优惠等你来"
          };
          "jdm" !== JD.device.scene && "1" !== JD.url.getUrlParam("_jdscene") || (c = {
              img_url: "//img11.360buyimg.com/jdphoto/s100x100_jfs/t2863/91/322027688/3768/b077080e/570e1d8cNe31f2aa8.png",
              link: "//wq.jd.com/mcoss/wxmall/home?ptype=1",
              title: "微信购物精选好货，多快好省，集您所需！",
              desc: "微信购物，京东直供，正品保证，新品首发，手快有手慢无！"
          })
      }
      function r() {
          wx.getNetworkType({
              success: function(e) {
                  console.log("initNewWorkType ok.." + e);
                  var n = e.networkType;
                  n = /wifi/i.test(n) ? "wifi" : /4g|3g+/i.test(n) ? "4g" : /3g/i.test(n) ? "3g" : /2g/i.test(n) ? "2g" : "unknown",
                  JD.cookie.set("network", n, 2, "/", "jd.com"),
                  window.FOOTDETECT && (window.FOOTDETECT.network = n)
              },
              fail: function(e) {
                  console.log("initNewWorkType error.." + e)
              }
          })
      }
      function a() {
          try {
              wx.invoke("currentMpInfo", {
                  brandIcon: "https://img11.360buyimg.com/jdphoto/s100x100_jfs/t21538/100/246443409/2542/d814095a/5b06706bN9e8f757a.png"
              }, function(e) {
                  console.log(e)
              })
          } catch (e) {
              console.log("not support:", e)
          }
      }
      if (!i && wx.apiCheckResult) {
          var s = wx.apiCheckResult;
          s.getNetworkType && r(),
          s.onMenuShareTimeline && t(),
          s.showMenuItems && n(),
          a(),
          i = !0,
          console.log("getNetworkType... init OK")
      }
      window.showTips = function(e) {}
  }
  var i = !1
    , o = !1;
  JD.wxapi.ready(function(i) {
      n(i),
      e()
  })
}(),
function() {
  function e(e) {
      var n = document.createElement("A");
      n.href = e;
      var i = n.search.replace(/^\?/, "");
      if (i) {
          i = i.split("&");
          var o = {};
          i.forEach(function(e) {
              var n = e.split("=");
              n && n[0] && !o[n[0]] && (o[n[0]] = n[1])
          });
          var t = [];
          for (var r in o)
              void 0 === o[r] ? t.push(r) : t.push(r + "=" + o[r]);
          i = "?" + t.join("&")
      }
      return n.protocol + "//" + n.hostname + n.pathname + i + n.hash
  }
  window.GLOBAL_SET_TRANSFER_ORIURL = function(e, n) {
      e && (window.GLOBAL_TRANSFER_ORIURL = e),
      window.GLOBAL_TRANSFER_ORIURL ? (window._transferCallback = function(e) {
          0 == e.retCode && e.bData ? (window.GLOBAL_TRANSFER_BACKUPURL = location.protocol + e.bData.replace(/^https?\:/, ""),
          n && n(window.GLOBAL_TRANSFER_BACKUPURL)) : n && n(!1)
      }
      ,
      JD.sendJs("//wq.jd.com/tranl/GetL?callback=_transferCallback&from=h5share&ori=" + encodeURIComponent(window.GLOBAL_TRANSFER_ORIURL), {
          onLoad: function() {},
          onError: function() {},
          defer: !0,
          async: !0
      })) : n && n(!1)
  }
  ,
  window.GLOBAL_SET_TRANSFER_ORIURL(),
  window.GLOBAL_GET_BACKSHAREURL = function(n) {
      if (window.GLOBAL_TRANSFER_BACKUPURL && window.GLOBAL_TRANSFER_ORIURL && n) {
          var i = document.createElement("A");
          i.href = n;
          var o = document.createElement("A");
          o.href = window.GLOBAL_TRANSFER_BACKUPURL;
          var t = document.createElement("A");
          return t.href = window.GLOBAL_TRANSFER_ORIURL,
          i.hostname + i.pathname == location.hostname + location.pathname || i.hostname + i.pathname == t.hostname + t.pathname ? e(window.GLOBAL_TRANSFER_BACKUPURL + (-1 == window.GLOBAL_TRANSFER_BACKUPURL.indexOf("?") ? "?" : "&") + i.search.replace(/^\?/, "") + i.hash) : n
      }
      return n
  }
  ,
  JD.events.trigger("backup_url_ready")
}();
